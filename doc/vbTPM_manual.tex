\documentclass[11pt,letterpaper,twocolumn]{article}
\usepackage[dvips]{graphicx}
\usepackage{fontspec}
\defaultfontfeatures{Ligatures=TeX}
\usepackage{amsmath}
\usepackage[numbers,sort&compress,round]{natbib}
\usepackage{url}
%\usepackage{epstopdf}
\usepackage{MLHMM}

\usepackage{color}
\usepackage[usenames,dvipsnames]{xcolor}
\newcommand{\jwm}[1]{\textcolor{MidnightBlue}{#1}}
\newcommand{\ml}[1]{\textcolor{BrickRed}{#1}}

%\usepackage{ulem}
\newcommand{\del}[1]{\sout{#1}}

\newcommand{\comment}[1]{{\bf [#1]}}

\newcommand{\parboxc}[1]{\parbox[t]{0.7\columnwidth}{
    \rule[5pt]{0pt}{5pt} \noindent #1 \rule[-3pt]{0pt}{5pt}}}
\newcommand{\parboxcc}[1]{
  \begin{minipage}[t]{0.7\textwidth}
    \rule[5pt]{0pt}{5pt} \noindent{#1} \rule[-3pt]{0pt}{5pt}
  \end{minipage}
%  \parbox[t]{0.7\textwidth}{\rule[5pt]{0pt}{5pt} \noindent #1 \rule[-3pt]{0pt}{5pt}}
}


\title{vbTPM user guide} 

\author{Martin Lind\'en, bmelinden@gmail.com, \today.}
\date{}

\begin{document}
\maketitle 
vbTPM is an acronym for variational Bayes for Tethered Particle
Motion. The latest version of this manual and the corresponding
software is available as open source via
\url{http://sourceforge.net/projects/vbtpm/}.
\tableofcontents
% some information that is useful for running the VB7 software for
% analyzing TPM traces.
\section*{To-do list}
Prior distributions. Maybe move some of it to manuscript SI?

Model search.

Factorial model, including priors.

Factorial algorithm.



\section{Getting started with vbTPM}
\input{vbTPM_getstarted.tex}
\section{Diffusive model for TPM}
\input{vbTPM_model.tex}
\section{The VB-algorithm}
\input{vbTPM_algorithm.tex}
\subsection{Notation and symbols}\label{sec:notation}
vbSPT stores mathematical objects in matlab structures that contain
parameters for the variational and prior distributions, and various
other things. In this section we list some of them.

First, \verb+VB7_batch_manage+ with the collect option returns a
filename, and cell vectors of structs that contain results of the
model search for each trajectory, indexed as the filenames in the
runinput file, e.g. \verb+trj{k}{j}+ contains the analysis result for
\verb+looping_filename{k}{j}+ etc. 

Most importantly, teh Wtrj and Wcal fields are the converged model
structs, whose content are detailed below (using W as the generic
model name). In addition the columns of the arrays
\verb+NFtrj+/\verb+NFcal+ contain $N,\hat N, F, iter$ for each model
that was converged during the nodel search, and $iter$ is the restart
number that produced it. In \verb+NFitrj/NFical+, the best model for
each size is listed in the same way, with the last column indicating
the rows in \verb+NFtrj,NFcal+ where these optimal models can be
found. 

Further details about the model structs are given in tables
\ref{tab:Wfields}-\ref{tab:Westimates}.

\begin{table}
\caption{Fields in a model object $W$.}\label{tab:Wfields}
\begin{center}\begin{tabular}{|l|l|}
\hline
field & \\
\hline
\hline
    \verb+W.N+& \parboxc{$N$, number of (genuine) states.} \\
    \hline
    \verb+W.Nc+& \parboxc{       
      Number of indicator states $\hat N$. $\hat N=1$ means no spurious
      states, i.e., the simple HMM.}\\ 
    \hline
    \verb+W.F+& \parboxc{Lower bound $F$.} \\
    \hline
\end{tabular}\end{center}
\end{table}

\begin{table}
\caption{Representration of variational distributions for genuine
  states in a model object named $W$.}\label{tab:Qparameters}
\begin{center}\begin{tabular}{|l|c|c|}
    \hline
    field & symbol & Eq.\\
    \hline\hline
    \verb+W.M.wPi(j)+& $ w_j^{(\vec{\pi})}$    & \\ 
    \verb+W.PM.wPi(j)+& $\tilde w_j^{(\vec{\pi})}$    & \eqref{seq:VBMpi}\\ 
    \verb+W.E.ds_1(j)+& $\mean{\delta_{j,s_1}}$ & \\ 
    \hline
    
    \verb+W.PM.wA(i,j)+& $\tilde w_{ij}^{(\matris{A})}$& \\ 
    \verb+W.M.wA(i,j)+& $w_{ij}^{(\matris{A})}$& \eqref{seq:VBMAj}\\ 
    \verb+W.E.wA(i,j)+& $\sum_{t=2}^T\mean{\delta_{i,s_{t-1}}\delta_{j,s_t}}$
    & \\ 
    \hline
    \verb+W.PM.n(j)+& $\tilde n_j$& \eqref{seq:nj}\\ 
    \verb+W.M.n(j)+& $n_j$& \eqref{seq:nj}\\ 
    \verb+W.E.M(j)+& $M_j$& \eqref{seq:Mj}\\ 
    \hline
    \verb+W.PM.c(j)+& $\tilde c_j$& \eqref{seq:cj}\\ 
    \verb+W.M.c(j)+& $c_j$& \eqref{seq:cj}\\ 
    \verb+W.E.C(j)+& $C_j$&\eqref{seq:Cj}\\
    \hline
    \verb+W.PM.v(j)+& $\tilde v_j$& \eqref{seq:vj}\\ 
    \verb+W.M.v(j)+& $v_j$& \eqref{seq:vj}\\ 
    \verb+W.E.V(j)+& $V_j$& \eqref{seq:Vj}\\ 
    \hline
    \verb+W.PM.mu(j)+& $\tilde \mu_j$& \eqref{seq:muj}\\
    \verb+W.M.mu(j)+& $\mu_j$& \eqref{seq:muj}\\  
    \verb+W.E.U(j)+& $U_j$&\eqref{seq:Uj}\\
    \hline
  \end{tabular}\end{center}\end{table}
\begin{table}
\caption{Representration of variational distributions for indicator
  states $c_t$ in a model object named $W$. Fields relating to the
  emission model (.n, .c, .v, .mu, etc.) have the same meaning as for
  the genuine states $s_t$, except that their first element is not
  used, since $c_t=1$ indicate a genuine state.}\label{tab:QSparameters}
\begin{center}  
  \begin{tabular}{|l|c|c|}
    \hline
    field & symbol & Eq.\\
    \hline\hline
%
    \hline
    \verb+W.Mc.wPi(j)+& $w_j^{(\vec{\pi})}$    & \\ 
    \verb+W.PMc.wPi(j)+& $\tilde w_j^{(\vec{\pi})}$    & \eqref{seq:VBMcpi}\\ 
    \verb+W.Ec.ds_1(j)+& $\mean{\delta_{j,c_1}}$ & \\ 
    \hline
     \verb+W.PMc.wA(j)+& & \\ 
    \verb+W.Mc.wA(j)+& & \eqref{seq:VBMcAj}\\ 
    \verb+W.Ec.wA(j)+& &\\
    \hline
     \verb+W.PMc.wR(i,j)+& & \\ 
    \verb+W.Mc.wR(i,j)+& & \eqref{seq:VBMcRj}\\ 
    \verb+W.Ec.wR(i,j)+&& \\
    \hline
  \end{tabular}
\end{center}
\end{table}
   
 \begin{table*}
\caption{Selected fields that characterize converged models (named
  W). The fields W.est and W.est2 are constructed by VB7\_VBEMiter.m
  (although W.est2 must be specifically requested), and fields not
  mentioned here can be looked up there. Averages are
  w.r.t. variational parameter distributions unless stated otherwise.}\label{tab:Westimates}
\begin{center}  
  \begin{tabular}{|l|l|}
    \hline   field & comment \\  \hline  
\hline
\verb+W.est.sAverage+&
\parboxcc{Occupation probability of genuine states $s_t$, computed by
  classification, i.e., sAverage(j) proportional to
  $\sum_t\mean{\delta_{j,s_t}}$.}\\
\hline
\verb+W.est.cAverage+&
\parboxcc{Occupation probability of indicator states
  $c_t$, by classification.}\\
\hline
\verb+W.est.sVisible+&
\parboxcc{Occupation probability of genuine states $s_t$, by classification that excludes spurious states, i.e., sAverage(j) proportional to $\sum_t\mean{\delta_{j,s_t}\delta_{1,c_t}}$.}\\
\hline
\hline
\verb+W.est.A+&
\parboxcc{Mean transition probabilities for genuine states,
  $\mean{\matris{A}}_{q(\matris{A})}$.}\\
\hline
\verb+W.est.dA+&
\parboxcc{Standard devition of stransition probability matrix
  $\matris{A}$.}\\
\hline
\verb+W.est.tD+&
\parboxcc{Mean dwell times of genuine states in units of time,
  computed from the elements of $\mean{\matris{A}}$.}\\
\hline
\verb+W.est.lnQss+&\parboxcc{Log average transition probabilities, goes into
  $q(s_{1:T})$.}\\
\hline
&\parboxcc{Corresponding averages for spurious state distributions are
  also computed, Ac, dAc, Rc, dRc, tStick, lnQcc, lnQsc, tStick, tUnstick.}\\
\hline\hline
\verb+W.est.sKaverage(j)+&$\mean{K_j}=\mu_j$.\\\hline
\verb+W.est.sBaverage(j)+&$\mean{B_j}$.\\\hline
\verb+W.est.sRMS(j)+&
$RMS_j=\sqrt{\mean{\x_t^2|s_t=j}}
\approx (\mean{B_j}(1-\mean{K_j}^2))^{-\frac 12}$.\\\hline
\verb+W.est.sTC(j)+&Approx. correlation time 
  $\tau_j\approx -\Delta t/\log\mean{K_j}$, units of time.\\\hline
\verb+W.est.sKstd(j)+&Standard deviation of $K_j$.\\\hline
\verb+W.est.sBstd(j)+&Standard deviation of $B_j$.\\\hline
\verb+W.est.cXXX+&Corresponding properties of spurious
  states are named with $s\to c$.\\ \hline\hline
\verb+W.est2.qt+& 
\parboxcc{State occupancy probability for combined states
  $(s_t,c_t)$. Use sMap and cMap to extract genuine/spurious
  occupancies, e.g.,\\ $p(s_t=j)=$sum(W.est2.qt(t,:).*(W.est.sMap==j)).}\\\hline
\verb+W.est2.sMaxP(t)+& Most likely genuine state at time $t$.\\
\verb+W.est2.cMaxP(t)+& Most likely indicator state at time $t$.\\
     % Viterbi paths. 
     % W.est2.zViterbi=uint8(VBlogViterbi(lnQ,lnqst,Q,qst));
%     \verb+W.est2.zViterbi=uint8(VBviterbi_log(lnQ,lnqst)); % faster!     
\verb+W.est2.sViterbi+& Viterbi path (most likely sequence of states) for $s_t$.\\
\verb+W.est2.cViterbi+& Viterbi path (most likely sequence of states) for $c_t$.\\\hline

&\parboxcc{W.est2 also contains a few other intermediate fields from
  the VBEM iteration that are mainly good for debugging. This
  substructure is thus very bulky and somewhat expensive to compute,
  which is the reason computing it is optional. }\\\hline
\end{tabular}\end{center}
\end{table*}  
\clearpage
\subsection{Doing empirical Bayes}
Our empirical Bayes analysis of multiple models was not implemented as
part of our analysis pipeline, but instead ran using tailored
scripts. These are not included with vbTPM, but the optimization
procedures for the individual prior distributions are included, in
\verb+VB7_EBupdate_dirichlet+, \verb+VB7_EBupdate_KB+, and
\verb+VB7_EBupdate_KB2+.

\bibliographystyle{unsrtnat}
\bibliography{references}%,jwm_single_molecule,jwm_machine_learning}

\end{document}
