\documentclass[11pt,letterpaper,twocolumn]{article}
\usepackage[dvips]{graphicx}
\usepackage{fontspec}
\defaultfontfeatures{Ligatures=TeX}
\usepackage{amsmath}
\usepackage[numbers,sort&compress,round]{natbib}
\usepackage{url}
%\usepackage{epstopdf}
\usepackage{MLHMM}

\usepackage{color}
\usepackage[usenames,dvipsnames]{xcolor}
\newcommand{\jwm}[1]{\textcolor{MidnightBlue}{#1}}
\newcommand{\ml}[1]{\textcolor{BrickRed}{#1}}

%\usepackage{ulem}
\newcommand{\del}[1]{\sout{#1}}

\newcommand{\comment}[1]{{\bf [#1]}}

\newcommand{\parboxc}[1]{\parbox[t]{0.7\columnwidth}{
    \rule[5pt]{0pt}{5pt} \noindent #1 \rule[-3pt]{0pt}{5pt}}}
\newcommand{\parboxcc}[1]{
  \begin{minipage}[t]{0.7\textwidth}
    \rule[5pt]{0pt}{5pt} \noindent{#1} \rule[-3pt]{0pt}{5pt}
  \end{minipage}
%  \parbox[t]{0.7\textwidth}{\rule[5pt]{0pt}{5pt} \noindent #1 \rule[-3pt]{0pt}{5pt}}
}


\title{vbTPM manual and user guide} 

\author{Martin Lind\'en, bmelinden@gmail.com, \today.}
\date{}

\begin{document}
\onecolumn
\maketitle 
\noindent 
vbTPM is an acronym for variational Bayes for Tethered Particle Motion
(TPM), and is a software package for analyzing TPM data.  The latest
version of this manual and the corresponding software is available as
open source via \url{http://sourceforge.net/projects/vbtpm/}. \bigskip\\
\noindent Copyright \copyright~2014 Martin Lindén. \smallskip\\
\noindent
The vbTPM package and documentation is free software: you can
redistribute it and/or modify it under the terms of the GNU General
Public License as published by the Free Software Foundation, either
version 3 of the License, or any later version.\smallskip\\
\noindent
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
General Public License for more details.\smallskip\\
\noindent
Additional permission under GNU GPL version 3 section 7: If you modify
this Program, or any covered work, by linking or combining it with
Matlab or any Matlab toolbox, the licensors of this Program grant you
additional permission to convey the resulting work.\smallskip\\
\noindent 
You should have received a copy of the GNU General Public License
along with this program. If not, see \url{http://www.gnu.org/licenses/}
\bigskip\\
\noindent 
If you use vbTPM in your research, please cite the original article in
your work:
\medskip\\
\noindent 
S. Johnson, J-W van de Meent, Rob Phillips, Chris H Wiggins, and
Martin Lindén. Multiple Lac-mediated loops revealed by Bayesian
statistics and tethered particle motion (manuscript in preparation,
2014).


\twocolumn
\tableofcontents
% some information that is useful for running the VB7 software for
% analyzing TPM traces.
\clearpage
\section{Getting started with vbTPM}
\input{vbTPM_getstarted.tex}
\section{Diffusive model for TPM}
\input{vbTPM_model.tex}
\section{The VB-algorithm}
\input{vbTPM_algorithm.tex}
\section{Extensions}
\input{vbTPM_extensions.tex}
\section{Notation and symbols}\label{sec:notation}
vbSPT stores mathematical objects in Matlab structures that contain
parameters for the variational and prior distributions, and various
other things. In this section we list some of them.

First, \verb+VB7_batch_manage+ with the collect option returns a
filename, and cell vectors of structs that contain results of the
model search for each trajectory, indexed as the filenames in the
runinput file, e.g. \verb+trj{k}{j}+ contains the analysis result for
\verb+looping_filename{k}{j}+ etc. 

Most importantly, the Wtrj and Wcal fields are the converged model
structs, whose content are detailed below (using W as the generic
model name). In addition the columns of the arrays
\texttt{NFtrj,NFcal} contain $N,\hat N, F, iter$ for each model that
was converged during the nodel search, and $iter$ is the restart
number that produced it. In \texttt{NFitrj,NFical}, the best model for
each size is listed in the same way, with the last column indicating
the rows in \texttt{NFtrj,NFcal} where these optimal models can be
found.

Further details about the model structs are given in tables
\ref{tab:Wfields}-\ref{tab:Westimates}.

\begin{table}
\caption{Fields in a model object $W$.}\label{tab:Wfields}
\begin{center}\begin{tabular}{|l|l|}
\hline
field & \\
\hline
\hline
    \texttt{W.N}& \parboxc{$N$, number of (genuine) states.} \\
    \hline
    \texttt{W.Nc}& \parboxc{ Number of indicator states $\hat
      N$+1. W.Nc=1 means no spurious states, i.e., the simple
      HMM.}\\
    \hline
    \texttt{W.F}& \parboxc{Lower bound $F$.} \\
    \hline
\end{tabular}\end{center}
\end{table}

\begin{table}
\caption{Representration of variational distributions for genuine
  states in a model object $W$.}\label{tab:Qparameters}
\begin{center}\begin{tabular}{|l|c|c|}
    \hline
    field & symbol & Eq.\\
    \hline\hline
    \texttt{W.M.wPi(j)}  & $ w_j^{(\vec{\pi})}$   \strutbeg & \\ 
    \texttt{W.PM.wPi(j)} & $\tilde w_j^{(\vec{\pi})}$    & \eqref{seq:VBMpi}\\ 
    \texttt{W.E.ds\_1(j)}& $\mean{\delta_{j,s_1}}$ \strutend& \\ 
    \hline
    
    \texttt{W.PM.wA(i,j)}& $\tilde w_{ij}^{(\matris{A})}$\strutbeg& \\ 
    \texttt{W.M.wA(i,j)}& $w_{ij}^{(\matris{A})}$& \eqref{seq:VBMAj}\\ 
    \texttt{W.E.wA(i,j)}& $\sum_{t=2}^T\mean{\delta_{i,s_{t-1}}\delta_{j,s_t}}$\strutend
    & \\ 
    \hline
    \texttt{W.PM.n(j)}& $\tilde n_j$& \eqref{seq:nj}\\ 
    \texttt{W.M.n(j)}& $n_j$& \eqref{seq:nj}\\ 
    \texttt{W.E.M(j)}& $M_j$& \eqref{seq:Mj}\\ 
    \hline
    \texttt{W.PM.c(j)}& $\tilde c_j$& \eqref{seq:cj}\\ 
    \texttt{W.M.c(j)}& $c_j$& \eqref{seq:cj}\\ 
    \texttt{W.E.C(j)}& $C_j$&\eqref{seq:Cj}\\
    \hline
    \texttt{W.PM.v(j)}& $\tilde v_j$& \eqref{seq:vj}\\ 
    \texttt{W.M.v(j)}& $v_j$& \eqref{seq:vj}\\ 
    \texttt{W.E.V(j)}& $V_j$& \eqref{seq:Vj}\\ 
    \hline
    \texttt{W.PM.mu(j)}& $\tilde \mu_j$& \eqref{seq:muj}\\
    \texttt{W.M.mu(j)}& $\mu_j$& \eqref{seq:muj}\\  
    \texttt{W.E.U(j)}& $U_j$&\eqref{seq:Uj}\\
    \hline
  \end{tabular}\end{center}\end{table}
\begin{table}
\caption{Representration of variational distributions for indicator
  states $c_t$ in a model object named $W$. Fields relating to the
  emission model (.n, .c, .v, .mu, etc.) have the same meaning as for
  the genuine states $s_t$, except that their first element is not
  used, since $c_t=1$ indicate a genuine state. Transition counts
  (.wA, .wR) are similarly analogous to those parameterizing the
  genuine transition matris $\matris{A}$.}\label{tab:QSparameters}
\begin{center}  
  \begin{tabular}{|l|c|c|}
    \hline
    field & symbol \\
    \hline\hline
    \texttt{W.Mc.wPi(j)} & $w_j^{(\hat{\vec{\pi}})}$         \strutbeg\\ 
    \texttt{W.PMc.wPi(j)}& $\tilde w_j^{(\hat{\vec{\pi}})}$    \\
    \texttt{W.Ec.ds\_1(j)}& $\mean{\delta_{j,c_1}}$  \strutend\\ 
    \hline
     \texttt{W.PMc.wA(j,k)}& $\tilde w_{jk}^{(\hat{\matris{A}})}$\strutbeg\\ 
    \texttt{W.Mc.wA(j,k)}  & $ w_{jk}^{(\hat{\matris{A}})}$\\ 
    \texttt{W.Ec.wA(j,k)}  & $\sum_t \mean{\delta_{j,s_t}\delta_{k,c_{t+1}}\delta_{1,c_t}}$    \strutend\\
    \hline
     \texttt{W.PMc.wR(j,k)}& $\tilde w_{jk}^{(\hat{\matris{R}})}$\strutbeg\\ 
    \texttt{W.Mc.wR(j,k)}  & $ w_{jk}^{(\hat{\matris{R}})}$\\ 
    \texttt{W.Ec.wR(j,k)}  & $\sum_t \mean{\delta_{j,c_t}\delta_{k,c_{t+1}}(1-\delta_{1,c_t})}$ \strutend\\    
    \hline
  \end{tabular}
\end{center}
\end{table}
   
 \begin{table*}
\caption{Selected fields that characterize converged models (named
  W). The fields W.est and W.est2 are constructed by VB7\_VBEMiter.m
  (although W.est2 must be specifically requested), and fields not
  mentioned here can be looked up there. Averages are
  w.r.t. variational parameter distributions unless stated otherwise.}\label{tab:Westimates}
\begin{center}  
  \begin{tabular}{|l|l|}
    \hline   field & comment \\  \hline  
\hline
\texttt{W.est.sAverage}&
\parboxcc{Occupation probability of genuine states $s_t$, computed by
  classification, i.e., sAverage(j) proportional to
  $\sum_t\mean{\delta_{j,s_t}}$.}\\
\hline
\texttt{W.est.cAverage}&
\parboxcc{Occupation probability of indicator states
  $c_t$, by classification.}\\
\hline
\texttt{W.est.sVisible}&
\parboxcc{Occupation probability of genuine states $s_t$, by classification that excludes spurious states, i.e., sAverage(j) proportional to $\sum_t\mean{\delta_{j,s_t}\delta_{1,c_t}}$.}\\
\hline
\hline
\texttt{W.est.A}&
\parboxcc{Mean transition probabilities for genuine states,
  $\mean{\matris{A}}_{q(\matris{A})}$.\strutend}\\
\hline
\texttt{W.est.dA}&
\parboxcc{Standard devition of stransition probability matrix
  $\matris{A}$.}\\
\hline
\texttt{W.est.tD}&
\parboxcc{Mean dwell times of genuine states in units of time,
  computed from the elements of $\mean{\matris{A}}$.\strutend}\\
\hline
\texttt{W.est.lnQss}&\parboxcc{Log average transition probabilities, goes into
  $q(s_{1:T})$.}\\
\hline
&\parboxcc{Corresponding averages for spurious state distributions are
  also computed, Ac, dAc, Rc, dRc, tStick, lnQcc, lnQsc, tStick, tUnstick.}\\
\hline\hline
\texttt{W.est.sKaverage(j)}&$\mean{K_j}=\mu_j$.\\\hline
\texttt{W.est.sBaverage(j)}&$\mean{B_j}$.\\\hline
\texttt{W.est.sRMS(j)}&\strutbeg\strutend
$RMS_j=\sqrt{\mean{\x_t^2|s_t=j}}
\approx (\mean{B_j}(1-\mean{K_j}^2))^{-\frac 12}$.\\\hline
\texttt{W.est.sTC(j)}&Approx. correlation time 
  $\tau_j\approx -\Delta t/\log\mean{K_j}$, units of time.\\\hline
\texttt{W.est.sKstd(j)}&Standard deviation of $K_j$.\\\hline
\texttt{W.est.sBstd(j)}&Standard deviation of $B_j$.\\\hline
\texttt{W.est.cXXX}&Corresponding properties of spurious
  states are named with $s\to c$.\\ \hline\hline
\texttt{W.est2.qt}& 
\parboxcc{State occupancy probability for combined states
  $(s_t,c_t)$. Use sMap and cMap to extract genuine/spurious
  occupancies, e.g.,\\ $p(s_t=j)=$sum(W.est2.qt(t,:).*(W.est.sMap==j)).}\\\hline
\texttt{W.est2.sMaxP(t)}& Most likely genuine state at time $t$.\\
\texttt{W.est2.cMaxP(t)}& Most likely indicator state at time $t$.\\
     % Viterbi paths. 
     % W.est2.zViterbi=uint8(VBlogViterbi(lnQ,lnqst,Q,qst));
%     \texttt{W.est2.zViterbi=uint8(VBviterbi_log(lnQ,lnqst)); % faster!     
\texttt{W.est2.sViterbi}& Viterbi path (most likely sequence of states) for $s_t$.\\
\texttt{W.est2.cViterbi}& Viterbi path (most likely sequence of states) for $c_t$.\\\hline

&\parboxcc{W.est2 also contains a few other intermediate fields from
  the VBEM iteration that are mainly good for debugging. This
  substructure is thus very bulky and somewhat expensive to compute,
  which is the reason computing it is optional. }\\\hline
\end{tabular}\end{center}
\end{table*}  

\clearpage
\addcontentsline{toc}{section}{References}
\bibliographystyle{unsrtnat}
\bibliography{references}%,jwm_single_molecule,jwm_machine_learning}

\end{document}
